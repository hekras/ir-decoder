const data0 = [{"x":0,"y":0},{"x":1504,"y":1},{"x":2133,"y":0},{"x":2363,"y":1},{"x":3414,"y":0},{"x":4062,"y":1},{"x":5121,"y":0},{"x":5771,"y":1},{"x":6829,"y":0},{"x":7060,"y":1},{"x":7683,"y":0},{"x":7914,"y":1},{"x":8536,"y":0},{"x":8766,"y":1},{"x":9389,"y":0},{"x":9621,"y":1},{"x":10243,"y":0},{"x":10890,"y":1},{"x":13051,"y":0},{"x":14555,"y":1},{"x":15614,"y":0},{"x":16261,"y":1},{"x":16893,"y":0},{"x":17122,"y":1},{"x":18174,"y":0},{"x":18821,"y":1},{"x":19881,"y":0},{"x":20113,"y":1},{"x":20735,"y":0},{"x":20967,"y":1},{"x":21589,"y":0},{"x":21822,"y":1},{"x":22442,"y":0},{"x":23085,"y":1},{"x":24149,"y":0},{"x":24380,"y":1},{"x":26093,"y":0},{"x":27592,"y":1},{"x":28655,"y":0},{"x":28884,"y":1},{"x":29509,"y":0},{"x":29765,"y":1},{"x":30363,"y":0},{"x":30589,"y":1},{"x":31216,"y":0},{"x":31864,"y":1},{"x":32923,"y":0},{"x":33152,"y":1},{"x":33777,"y":0},{"x":34033,"y":1},{"x":34631,"y":0},{"x":34862,"y":1},{"x":35487,"y":0},{"x":36129,"y":1},{"x":36764,"y":0},{"x":37018,"y":1},{"x":39140,"y":0},{"x":40641,"y":1},{"x":41702,"y":0},{"x":41924,"y":1},{"x":42555,"y":0},{"x":42813,"y":1},{"x":43409,"y":0},{"x":43635,"y":1},{"x":44262,"y":0},{"x":44913,"y":1},{"x":45970,"y":0},{"x":46190,"y":1},{"x":46823,"y":0},{"x":47077,"y":1},{"x":47677,"y":0},{"x":48347,"y":1},{"x":49384,"y":0},{"x":49605,"y":1},{"x":50237,"y":0},{"x":50493,"y":1},{"x":52181,"y":0},{"x":53709,"y":1},{"x":54743,"y":0},{"x":55415,"y":1},{"x":56023,"y":0},{"x":56246,"y":1},{"x":57303,"y":0},{"x":57977,"y":1},{"x":59011,"y":0},{"x":59230,"y":1},{"x":59865,"y":0},{"x":60110,"y":1},{"x":60718,"y":0},{"x":61390,"y":1},{"x":62426,"y":0},{"x":63101,"y":1},{"x":65231,"y":0},{"x":66331,"y":1},{"x":66940,"y":0},{"x":67611,"y":1},{"x":68220,"y":0},{"x":68468,"y":1},{"x":69500,"y":0},{"x":69719,"y":1},{"x":70354,"y":0},{"x":70601,"y":1},{"x":71208,"y":0},{"x":71427,"y":1},{"x":72060,"y":0},{"x":72307,"y":1},{"x":72915,"y":0},{"x":73133,"y":1},{"x":73768,"y":0},{"x":74439,"y":1},{"x":75476,"y":0},{"x":75693,"y":1},{"x":76330,"y":0},{"x":76575,"y":1}];
const dataCRSP = [{"x":0,"y":0},{"x":1533,"y":1},{"x":2561,"y":0},{"x":2789,"y":1},{"x":3415,"y":0},{"x":3642,"y":1},{"x":4268,"y":0},{"x":4495,"y":1},{"x":5122,"y":0},{"x":5776,"y":1},{"x":6829,"y":0},{"x":7058,"y":1},{"x":7683,"y":0},{"x":7911,"y":1},{"x":8536,"y":0},{"x":8765,"y":1},{"x":9390,"y":0},{"x":10070,"y":1},{"x":10672,"y":0},{"x":10899,"y":1},{"x":13043,"y":0},{"x":14124,"y":1},{"x":14754,"y":0},{"x":14979,"y":1},{"x":15605,"y":0},{"x":15832,"y":1},{"x":16458,"y":0},{"x":17112,"y":1},{"x":18169,"y":0},{"x":18820,"y":1},{"x":19873,"y":0},{"x":20527,"y":1},{"x":21581,"y":0},{"x":21809,"y":1},{"x":22434,"y":0},{"x":23113,"y":1},{"x":24141,"y":0},{"x":24369,"y":1},{"x":26089,"y":0},{"x":27172,"y":1},{"x":27796,"y":0},{"x":28478,"y":1},{"x":29503,"y":0},{"x":29731,"y":1},{"x":30357,"y":0},{"x":30585,"y":1},{"x":31211,"y":0},{"x":31864,"y":1},{"x":32918,"y":0},{"x":33171,"y":1},{"x":33772,"y":0},{"x":34427,"y":1},{"x":35479,"y":0},{"x":35707,"y":1},{"x":36332,"y":0},{"x":36986,"y":1},{"x":39135,"y":0},{"x":40216,"y":1},{"x":40842,"y":0},{"x":41070,"y":1},{"x":41696,"y":0},{"x":42350,"y":1},{"x":43404,"y":0},{"x":43631,"y":1},{"x":44257,"y":0},{"x":44911,"y":1},{"x":45964,"y":0},{"x":46618,"y":1},{"x":47672,"y":0},{"x":47900,"y":1},{"x":48526,"y":0},{"x":49179,"y":1},{"x":49805,"y":0},{"x":50033,"y":1},{"x":52183,"y":0},{"x":53260,"y":1},{"x":53888,"y":0},{"x":54542,"y":1},{"x":55595,"y":0},{"x":55821,"y":1},{"x":56448,"y":0},{"x":56676,"y":1},{"x":57302,"y":0},{"x":57955,"y":1},{"x":59009,"y":0},{"x":59663,"y":1},{"x":60716,"y":0},{"x":60944,"y":1},{"x":61570,"y":0},{"x":61797,"y":1},{"x":62424,"y":0},{"x":62651,"y":1},{"x":63278,"y":0},{"x":63505,"y":1},{"x":65229,"y":0},{"x":66309,"y":1},{"x":66937,"y":0},{"x":67594,"y":1},{"x":68217,"y":0},{"x":68444,"y":1},{"x":69497,"y":0},{"x":69726,"y":1},{"x":70352,"y":0},{"x":70580,"y":1},{"x":71206,"y":0},{"x":71433,"y":1},{"x":72059,"y":0},{"x":72287,"y":1},{"x":72914,"y":0},{"x":73141,"y":1},{"x":73768,"y":0},{"x":74420,"y":1},{"x":75474,"y":0},{"x":75700,"y":1},{"x":76328,"y":0},{"x":76555,"y":1}];
const dataOLDHANDMIXER = [{"x":0,"y":0},{"x":1081,"y":1},{"x":1706,"y":0},{"x":2364,"y":1},{"x":2986,"y":0},{"x":3215,"y":1},{"x":3840,"y":0},{"x":4068,"y":1},{"x":5120,"y":0},{"x":5774,"y":1},{"x":6828,"y":0},{"x":7057,"y":1},{"x":7682,"y":0},{"x":8337,"y":1},{"x":8964,"y":0},{"x":9191,"y":1},{"x":9815,"y":0},{"x":10044,"y":1},{"x":10669,"y":0},{"x":10898,"y":1},{"x":13046,"y":0},{"x":14126,"y":1},{"x":14752,"y":0},{"x":15008,"y":1},{"x":15606,"y":0},{"x":15834,"y":1},{"x":16460,"y":0},{"x":17142,"y":1},{"x":18170,"y":0},{"x":18822,"y":1},{"x":19875,"y":0},{"x":20102,"y":1},{"x":20729,"y":0},{"x":21383,"y":1},{"x":22008,"y":0},{"x":22237,"y":1},{"x":23289,"y":0},{"x":23517,"y":1},{"x":24142,"y":0},{"x":24370,"y":1},{"x":26092,"y":0},{"x":27600,"y":1},{"x":28653,"y":0},{"x":28907,"y":1},{"x":29506,"y":0},{"x":29735,"y":1},{"x":30361,"y":0},{"x":30589,"y":1},{"x":31214,"y":0},{"x":31898,"y":1},{"x":32921,"y":0},{"x":33150,"y":1},{"x":33775,"y":0},{"x":34030,"y":1},{"x":34629,"y":0},{"x":35312,"y":1},{"x":36335,"y":0},{"x":36564,"y":1},{"x":37190,"y":0},{"x":37418,"y":1},{"x":39134,"y":0},{"x":40243,"y":1},{"x":40841,"y":0},{"x":41525,"y":1},{"x":42121,"y":0},{"x":42349,"y":1},{"x":42974,"y":0},{"x":43230,"y":1},{"x":44256,"y":0},{"x":44909,"y":1},{"x":45962,"y":0},{"x":46217,"y":1},{"x":46816,"y":0},{"x":47495,"y":1},{"x":48522,"y":0},{"x":48751,"y":1},{"x":49377,"y":0},{"x":49609,"y":1},{"x":50230,"y":0},{"x":50459,"y":1},{"x":52182,"y":0},{"x":53690,"y":1},{"x":54316,"y":0},{"x":54544,"y":1},{"x":55599,"y":0},{"x":56252,"y":1},{"x":57304,"y":0},{"x":57984,"y":1},{"x":59012,"y":0},{"x":59239,"y":1},{"x":59865,"y":0},{"x":60094,"y":1},{"x":60718,"y":0},{"x":60974,"y":1},{"x":61573,"y":0},{"x":61802,"y":1},{"x":62426,"y":0},{"x":63081,"y":1},{"x":65225,"y":0},{"x":66330,"y":1},{"x":66931,"y":0},{"x":67613,"y":1},{"x":68639,"y":0},{"x":68867,"y":1},{"x":69494,"y":0},{"x":69748,"y":1},{"x":70346,"y":0},{"x":71031,"y":1},{"x":72053,"y":0},{"x":72311,"y":1},{"x":72907,"y":0},{"x":73563,"y":1},{"x":74187,"y":0},{"x":74444,"y":1},{"x":75041,"y":0},
                          {"x":75295,"y":1},{"x":76322,"y":0},{"x":76578,"y":1},{"x":78270,"y":0},{"x":79806,"y":1},{"x":80831,"y":0},{"x":81060,"y":1},{"x":81685,"y":0},{"x":81941,"y":1},{"x":82538,"y":0},{"x":82796,"y":1},{"x":83392,"y":0},{"x":84077,"y":1},{"x":85099,"y":0},{"x":85355,"y":1},{"x":85953,"y":0},{"x":86208,"y":1},{"x":86807,"y":0},{"x":87482,"y":1},{"x":88513,"y":0},{"x":88773,"y":1},{"x":89367,"y":0},{"x":89625,"y":1},{"x":91315,"y":0},{"x":92425,"y":1},{"x":93022,"y":0},{"x":93280,"y":1},{"x":93876,"y":0},{"x":94560,"y":1},{"x":95583,"y":0},{"x":95841,"y":1},{"x":96437,"y":0},{"x":97121,"y":1},{"x":98144,"y":0},{"x":98401,"y":1},{"x":98998,"y":0},{"x":99681,"y":1},{"x":100278,"y":0},{"x":100537,"y":1},{"x":101559,"y":0},{"x":102244,"y":1},{"x":104354,"y":0},{"x":105492,"y":1},{"x":106062,"y":0},{"x":106744,"y":1},{"x":107769,"y":0},{"x":108026,"y":1},{"x":108623,"y":0},{"x":108879,"y":1},{"x":109477,"y":0},{"x":110159,"y":1},{"x":111184,"y":0},{"x":111440,"y":1},{"x":112038,"y":0},{"x":112721,"y":1},{"x":113745,"y":0},{"x":113999,"y":1},{"x":114598,"y":0},{"x":115282,"y":1},{"x":117394,"y":0},{"x":118953,"y":1},{"x":119527,"y":0},{"x":119781,"y":1},{"x":120808,"y":0},{"x":121489,"y":1},{"x":122516,"y":0},{"x":123195,"y":1},{"x":124223,"y":0},{"x":124903,"y":1},{"x":125503,"y":0},{"x":125753,"y":1},{"x":126784,"y":0},{"x":127032,"y":1},{"x":127637,"y":0},{"x":127887,"y":1},{"x":128491,"y":0},{"x":128740,"y":1},{"x":130448,"y":0},{"x":131979,"y":1},{"x":133010,"y":0},{"x":133685,"y":1},{"x":134290,"y":0},{"x":134562,"y":1},{"x":135571,"y":0},{"x":136246,"y":1},{"x":137279,"y":0},{"x":137549,"y":1},{"x":138132,"y":0},{"x":138403,"y":1},{"x":138985,"y":0},{"x":139684,"y":1},{"x":140693,"y":0},{"x":141390,"y":1},{"x":143489,"y":0},{"x":144614,"y":1},{"x":145194,"y":0},{"x":145461,"y":1},{"x":146053,"y":0},{"x":146319,"y":1},{"x":146906,"y":0},{"x":147600,"y":1},{"x":148611,"y":0},{"x":149307,"y":1},{"x":150319,"y":0},{"x":151013,"y":1},{"x":152025,"y":0},{"x":152290,"y":1},{"x":152879,"y":0},{"x":153573,"y":1},{"x":154586,"y":0},
                          {"x":154849,"y":1},{"x":156562,"y":0},{"x":157651,"y":1},{"x":158241,"y":0},{"x":158929,"y":1},{"x":159520,"y":0},{"x":159756,"y":1},{"x":160800,"y":0},{"x":161037,"y":1},{"x":161653,"y":0},{"x":161890,"y":1},{"x":162508,"y":0},{"x":162746,"y":1},{"x":163361,"y":0},{"x":163598,"y":1},{"x":164215,"y":0},{"x":164452,"y":1},{"x":165069,"y":0},{"x":165733,"y":1},{"x":166775,"y":0},{"x":167012,"y":1},{"x":167629,"y":0},{"x":167867,"y":1}]
const data3 = [{"x":0,"y":0},{"x":1127,"y":1},{"x":1706,"y":0},{"x":2432,"y":1},{"x":3414,"y":0},{"x":3718,"y":1},{"x":4267,"y":0},{"x":4567,"y":1},{"x":5121,"y":0},{"x":5851,"y":1},{"x":6828,"y":0},{"x":7128,"y":1},{"x":7682,"y":0},{"x":8408,"y":1},{"x":8963,"y":0},{"x":9235,"y":1},{"x":9815,"y":0},{"x":10122,"y":1},{"x":11096,"y":0},{"x":11396,"y":1},{"x":13047,"y":0},{"x":14174,"y":1},{"x":14755,"y":0},{"x":15447,"y":1},{"x":16035,"y":0},{"x":16333,"y":1},{"x":17316,"y":0},{"x":17587,"y":1},{"x":18170,"y":0},{"x":18443,"y":1},{"x":19023,"y":0},{"x":19321,"y":1},{"x":19877,"y":0},{"x":20175,"y":1},{"x":20731,"y":0},{"x":21028,"y":1},{"x":21584,"y":0},{"x":22276,"y":1},{"x":23292,"y":0},{"x":23562,"y":1},{"x":24145,"y":0},{"x":24415,"y":1}]
const dataASSEMBLY_25 = [{"x":0,"y":0},{"x":1508,"y":1},{"x":2133,"y":0},{"x":2360,"y":1},{"x":3414,"y":0},{"x":4069,"y":1},{"x":5122,"y":0},{"x":5804,"y":1},{"x":6830,"y":0},{"x":7085,"y":1},{"x":7683,"y":0},{"x":7910,"y":1},{"x":8537,"y":0},{"x":8792,"y":1},{"x":9391,"y":0},{"x":9618,"y":1},{"x":10245,"y":0},{"x":10899,"y":1},{"x":13043,"y":0},{"x":14152,"y":1},{"x":14752,"y":0},{"x":15006,"y":1},{"x":15606,"y":0},{"x":16260,"y":1},{"x":17313,"y":0},{"x":17566,"y":1},{"x":18167,"y":0},{"x":18847,"y":1},{"x":19875,"y":0},{"x":20555,"y":1},{"x":21582,"y":0},{"x":21836,"y":1},{"x":22436,"y":0},{"x":23116,"y":1},{"x":23716,"y":0},{"x":23973,"y":1},{"x":26091,"y":0},{"x":27200,"y":1},{"x":27802,"y":0},{"x":28056,"y":1},{"x":28653,"y":0},{"x":29335,"y":1},{"x":30363,"y":0},{"x":30613,"y":1},{"x":31214,"y":0},{"x":31892,"y":1},{"x":32921,"y":0},{"x":33605,"y":1},{"x":34629,"y":0},{"x":34885,"y":1},{"x":35484,"y":0},{"x":36162,"y":1},{"x":36763,"y":0},{"x":37017,"y":1},{"x":39135,"y":0},{"x":40670,"y":1},{"x":41693,"y":0},{"x":42378,"y":1},{"x":42977,"y":0},{"x":43230,"y":1},{"x":44258,"y":0},{"x":44942,"y":1},{"x":45966,"y":0},{"x":46217,"y":1},{"x":46819,"y":0},{"x":47071,"y":1},{"x":47674,"y":0},{"x":48352,"y":1},{"x":49382,"y":0},{"x":50061,"y":1},{"x":52182,"y":0},{"x":53290,"y":1},{"x":53891,"y":0},{"x":54142,"y":1},{"x":54744,"y":0},{"x":55422,"y":1},{"x":56450,"y":0},{"x":56700,"y":1},{"x":57305,"y":0},{"x":57982,"y":1},{"x":59013,"y":0},{"x":59261,"y":1},{"x":59867,"y":0},{"x":60543,"y":1},{"x":61147,"y":0},{"x":61396,"y":1},{"x":62428,"y":0},{"x":63104,"y":1},{"x":65231,"y":0},{"x":66761,"y":1},{"x":67793,"y":0},{"x":68468,"y":1},{"x":69073,"y":0},{"x":69345,"y":1},{"x":70355,"y":0},{"x":71029,"y":1},{"x":72063,"y":0},{"x":72332,"y":1},{"x":72917,"y":0},{"x":73185,"y":1},{"x":73771,"y":0},{"x":74040,"y":1},{"x":74624,"y":0},{"x":75320,"y":1},{"x":76332,"y":0},{"x":76600,"y":1},{"x":78287,"y":0},{"x":79410,"y":1},{"x":79997,"y":0},{"x":80262,"y":1},{"x":80851,"y":0},{"x":81115,"y":1},{"x":81705,"y":0},{"x":82398,"y":1},{"x":83410,"y":0},
                      {"x":84105,"y":1},{"x":85118,"y":0},{"x":85382,"y":1},{"x":85974,"y":0},{"x":86665,"y":1},{"x":87256,"y":0},{"x":87491,"y":1},{"x":88533,"y":0},{"x":88771,"y":1},{"x":89387,"y":0},{"x":89626,"y":1},{"x":91334,"y":0},{"x":92854,"y":1},{"x":93469,"y":0},{"x":93706,"y":1},{"x":94322,"y":0},{"x":94559,"y":1},{"x":95604,"y":0},{"x":95844,"y":1},{"x":96457,"y":0},{"x":97122,"y":1},{"x":98165,"y":0},{"x":98827,"y":1},{"x":99445,"y":0},{"x":99682,"y":1},{"x":100727,"y":0},{"x":100967,"y":1},{"x":101580,"y":0},{"x":102243,"y":1},{"x":104384,"y":0},{"x":105902,"y":1},{"x":106519,"y":0},{"x":106758,"y":1},{"x":107803,"y":0},{"x":108038,"y":1},{"x":108653,"y":0},{"x":108893,"y":1},{"x":109508,"y":0},{"x":109746,"y":1},{"x":110361,"y":0},{"x":111025,"y":1},{"x":112068,"y":0},{"x":112307,"y":1},{"x":112923,"y":0},{"x":113160,"y":1},{"x":113777,"y":0},{"x":114014,"y":1},{"x":114630,"y":0},{"x":114867,"y":1},{"x":115484,"y":0},{"x":115719,"y":1},{"x":117427,"y":0},{"x":118518,"y":1},{"x":119136,"y":0},{"x":119372,"y":1},{"x":119990,"y":0},{"x":120653,"y":1},{"x":121271,"y":0},{"x":121506,"y":1},{"x":122552,"y":0},{"x":122787,"y":1},{"x":123405,"y":0},{"x":124068,"y":1},{"x":124686,"y":0},{"x":124925,"y":1},{"x":125968,"y":0},{"x":126207,"y":1},{"x":126822,"y":0},{"x":127484,"y":1},{"x":128529,"y":0},{"x":128769,"y":1},{"x":130473,"y":0},{"x":131566,"y":1},{"x":132181,"y":0},{"x":132422,"y":1},{"x":133035,"y":0},{"x":133702,"y":1},{"x":134315,"y":0},{"x":134556,"y":1},{"x":135597,"y":0},{"x":135836,"y":1},{"x":136451,"y":0},{"x":137118,"y":1},{"x":137732,"y":0},{"x":137968,"y":1},{"x":139013,"y":0},{"x":139703,"y":1},{"x":140721,"y":0},{"x":141386,"y":1},{"x":143523,"y":0},{"x":144613,"y":1},{"x":145233,"y":0},{"x":145892,"y":1},{"x":146512,"y":0},{"x":146715,"y":1},{"x":147817,"y":0},{"x":147996,"y":1},{"x":148650,"y":0},{"x":148876,"y":1},{"x":149525,"y":0},{"x":149732,"y":1},{"x":150381,"y":0},{"x":150590,"y":1},{"x":151233,"y":0},{"x":151448,"y":1},{"x":152086,"y":0},{"x":152718,"y":1},{"x":153794,"y":0},{"x":154005,"y":1},{"x":154648,"y":0},{"x":154855,"y":1}]
const dataNOISE = [{"x":0,"y":0},{"x":1080,"y":1},{"x":1704,"y":0},{"x":2362,"y":1},{"x":3412,"y":0},{"x":3668,"y":1},{"x":4266,"y":0},{"x":4522,"y":1},{"x":5120,"y":0},{"x":5804,"y":1},{"x":6827,"y":0},{"x":7083,"y":1},{"x":7681,"y":0},{"x":8339,"y":1},{"x":8962,"y":0},{"x":9191,"y":1},{"x":9815,"y":0},{"x":10045,"y":1},{"x":11097,"y":0},{"x":11326,"y":1},{"x":13038,"y":0},{"x":14149,"y":1},{"x":14746,"y":0},{"x":15429,"y":1},{"x":16027,"y":0},{"x":16280,"y":1},{"x":16881,"y":0},{"x":17135,"y":1},{"x":18162,"y":0},{"x":18844,"y":1},{"x":19870,"y":0},{"x":20098,"y":1},{"x":20724,"y":0},{"x":21404,"y":1},{"x":22004,"y":0},{"x":22261,"y":1},{"x":22857,"y":0},{"x":23086,"y":1},{"x":23712,"y":0},{"x":23967,"y":1},{"x":26107,"y":0},{"x":27216,"y":1},{"x":27815,"y":0},{"x":28495,"y":1},{"x":29523,"y":0},{"x":29778,"y":1},{"x":30377,"y":0},{"x":30634,"y":1},{"x":31230,"y":0},{"x":31913,"y":1},{"x":32939,"y":0},{"x":33168,"y":1},{"x":33793,"y":0},{"x":34476,"y":1},{"x":35500,"y":0},{"x":35753,"y":1},{"x":36354,"y":0},{"x":37034,"y":1},{"x":39154,"y":0},{"x":40266,"y":1},{"x":40861,"y":0},{"x":41117,"y":1},{"x":41715,"y":0},{"x":42401,"y":1},{"x":43423,"y":0},{"x":43679,"y":1},{"x":44277,"y":0},{"x":44961,"y":1},{"x":45985,"y":0},{"x":46670,"y":1},{"x":47694,"y":0},{"x":47976,"y":1},{"x":48547,"y":0},{"x":49233,"y":1},{"x":49827,"y":0},{"x":50085,"y":1},{"x":52196,"y":0},{"x":53762,"y":1},{"x":54759,"y":0},{"x":55444,"y":1},{"x":56039,"y":0},{"x":56298,"y":1},{"x":57320,"y":0},{"x":58006,"y":1},{"x":59028,"y":0},{"x":59312,"y":1},{"x":59882,"y":0},{"x":60140,"y":1},{"x":60736,"y":0},{"x":61423,"y":1},{"x":62443,"y":0},{"x":63127,"y":1},{"x":65241,"y":0},{"x":66354,"y":1},{"x":66949,"y":0},{"x":67659,"y":1},{"x":68229,"y":0},{"x":68488,"y":1},{"x":69510,"y":0},{"x":69767,"y":1},{"x":70364,"y":0},{"x":70623,"y":1},{"x":71217,"y":0},{"x":71475,"y":1},{"x":72072,"y":0},{"x":72354,"y":1},{"x":72926,"y":0},{"x":73183,"y":1},{"x":73780,"y":0},{"x":74489,"y":1},{"x":75486,"y":0},{"x":75744,"y":1},{"x":76341,"y":0},{"x":76597,"y":1}]
const rawdata = [{"x":0,"y":0},{"x":1532,"y":1},{"x":2133,"y":0},{"x":2363,"y":1},{"x":3414,"y":0},{"x":4096,"y":1},{"x":5121,"y":0},{"x":5802,"y":1},{"x":6829,"y":0},{"x":7083,"y":1},{"x":7683,"y":0},{"x":7936,"y":1},{"x":8536,"y":0},{"x":8791,"y":1},{"x":9390,"y":0},{"x":9621,"y":1},{"x":10244,"y":0},{"x":10901,"y":1},{"x":13045,"y":0},{"x":14153,"y":1},{"x":14754,"y":0},{"x":15435,"y":1},{"x":16034,"y":0},{"x":16289,"y":1},{"x":17315,"y":0},{"x":17572,"y":1},{"x":18169,"y":0},{"x":18407,"y":1},{"x":19019,"y":0},{"x":19275,"y":1},{"x":19877,"y":0},{"x":20107,"y":1},{"x":20730,"y":0},{"x":20960,"y":1},{"x":21584,"y":0},{"x":22268,"y":1},{"x":23291,"y":0},{"x":23547,"y":1},{"x":24145,"y":0},{"x":24375,"y":1}]

let data = [];
let animateflag = true

const capturequeue = [data0, data3, dataASSEMBLY_25, rawdata, dataOLDHANDMIXER, dataNOISE];
let captureindex = 0;

var triggers = [
  {key:"A", level:0, t1:100, t2:450, el:null},
  {key:"B", level:1, t1:50, t2:800, el:null},
  {key:"C", level:0, t1:550, t2:850, el:null},
  {key:"D", level:1, t1:950, t2:1300, el:null},
  {key:"START", level:0, t1:1000, t2:1200000, el:null},
  {key:"STOP", level:1, t1:1600, t2:1200000, el:null},
];

var codebook = 
[{"code":"BADCDCDABABABABC","key":"A"},{"code":"BCBADABABABABABCDABA","key":"EOL"},{"code":"BCBABADCDABCBABABA","key":"O"},{"code":"BABABCDCDABCBADABA","key":"L"},{"code":"DABABABCDABABCDABA","key":"D"},{"code":"BCBABADCDABCDABABA","key":"H"},{"code":"BCDABABCDABCBABADA","key":"N"},{"code":"BABCDABCDABCBADC","key":"M"},{"code":"BCDABABCDABCDABC","key":"!"},{"code":"BADCDCDCBADABABA","key":"X"},{"code":"DCBADCDABABCDC","key":"E"},{"code":"BABABCDCDCDABCDA","key":"R"},{"code":"DABABABCDABABABCBA","key":"C"},{"code":"BABCDABCDCDABCBA","key":"S"},{"code":"BCDABABCDCDABABABA","key":"P"},{"code":"DCBADCDABABABCDA","key":"B"},{"code":"BABADABCDCBADABC","key":"Y"},{"code":"BADABABABCDABABABABA","key":"_"},{"code":"BABCBADABCBADABCDA","key":"2"},{"code":"BABCBADABCBADCDC","key":"5"}];

var message = [];

let trigger1Hover = null; // when mouse is over trigger.t1
let trigger2Hover = null; // when mouse is over trigger.t2
let trigger3Hover = null; // when mouse is over trigger-rectangle

function div(type,id,x,y,w,h,t,fontsize = "20px", c="black",b=false){
  switch(type){
    case "label": 
    {
      const el = document.createElement("div");
      el.style.width = w + "px";
      el.style.height = h + "px";
      el.style.left = x +"px";
      el.style.top = y + "px";
      el.style.position = "absolute";
      el.style.zIndex = 2;
      el.style.fontSize = fontsize;
      el.style.color = c;
      if (id != null) el.id = id;
      el.innerText = t;
      document.getElementById("settings").appendChild(el);
      return el;
    }
    case "message-label": 
    {
      const el = document.createElement("div");
      el.style.width = "auto";
      el.style.height = "auto";
      el.style.left = x +"px";
      el.style.top = y + "px";
      el.style.position = "absolute";
      el.style.zIndex = 2;
      el.style.fontSize = fontsize;
      el.style.color = c;
      if (id != null) el.id = id;
      el.innerText = t;
      document.getElementById("timing").appendChild(el);
      return el;
    }
    case "trigger": 
    {
      const el = document.createElement("div");
      el.style.width = "auto";
      el.style.height = "auto";
      el.style.left = x +"px";
      el.style.top = y + "px";
      el.style.position = "absolute";
      el.style.zIndex = 2;
      el.style.fontSize = fontsize;
      el.style.color = c;
      el.innerText = t;
      return el;
    }
    case "cursor":
    {
      const el = document.createElement("div");
      el.style.width = "auto";
      el.style.height = "auto";
      el.style.left = x +"px";
      el.style.top = y + "px";
      el.style.position = "absolute";
      el.style.zIndex = 2;
      el.style.fontSize = "21px";
      el.style.color = c;
      if (id != null) el.id = id;
      el.innerText = t;
      document.getElementById("settings").appendChild(el);
      return el;
    }
    case "measure-button":
    {
      const el = document.createElement("button");
      el.style.width = w + "px";
      el.style.height = h + "px";
      el.style.left = x +"px";
      el.style.top = y + "px";
      el.style.position = "absolute";
      el.style.zIndex = 2;
      el.style.fontSize = fontsize;
      el.style.display = "flex"; // Use flexbox
      el.style.alignItems = "center"; // Vertically center text
      el.style.justifyContent = "center"; // Horizontally center text
      el.style.textAlign = "center"; // Ensure text alignment
      el.style.color = c;
      if (id != null){
        el.id = id;
        switch(id){
          case "sample-button":
            el.addEventListener("click", function(){
              handleRecord("sample-button");
              handleSampleButton();
            });
            break;
          case "measure-button":
            el.addEventListener("click", function(){
              if (state == "idle"){
                animateflag = false;
                state = "init-glitch";
              }
            });
            break;
          }
      }
      el.innerText = t;
      document.getElementById("settings").appendChild(el);
      return el;
    }
    case "macro-button":
    {
      const el = document.createElement("div");
      el.style.width = "flex";
      el.style.height = "flex";
      el.style.left = x +"px";
      el.style.top = y + "px";
      el.style.position = "absolute";
      el.style.zIndex = 2;
      el.style.fontSize = fontsize;
      el.style.cursor = "pointer"; // Change cursor to pointer
      el.style.display = "flex"; // Use flexbox
      el.style.alignItems = "center"; // Vertically center text
      el.style.justifyContent = "center"; // Horizontally center text
      el.style.textAlign = "center"; // Ensure text alignment
      el.style.color = c;
      if (id != null){
        el.id = id;
        switch(id){
          case "macro-record":
            el.addEventListener("click", function(){
              if (macro.state == "idle"){
                macro.state = "record";
                macro.data = [];
                macro.starttime = Date.now();
              }
            });
            break;
          case "macro-stop":
            el.addEventListener("click", function(){
              if (macro.state == "record"){
                handleRecord("macro-stop");
                macro.state = "idle";
                document.getElementById("macro-record").style.display = "block";
              } else if (macro.state == "play"){
                macro.state = "idle";
                customCursor.style.display = "none";
                document.getElementById("macro-play-pause").style.display = "block";
              }
              updateMacroTimer(macro.data[macro.data.length-1].time);
            });
            break;
          case "macro-play-pause":
            el.addEventListener("click", function(){
              if (macro.state == "idle"){
                macro.state = "play";
                macro.playtime = Date.now();
                macro.datapointer = 0;
              }else if (macro.state == "play"){
                macro.state = "pause";
              } else if (macro.state == "pause"){
                macro.state = "play";
              }
            });
            break;
        }
      }
      el.innerText = t;
      document.getElementById("settings").appendChild(el);
      return el;
    }
    case "custom-cursor":
    {
      const el = document.createElement("div");
      el.id = id;
      el.style.width = "10px";
      el.style.height = "10px";
      el.style.backgroundColor = "red";
      el.style.position = "absolute";
      el.style.borderRadius = "50%";
      el.style.zIndex = 3; // Ensure it's above the canvas
      el.style.pointerEvents = "none"; // Prevent interference with other elements
      el.innerText = ""
      document.body.appendChild(el);
      return el;
    }
  }
}

function decodePhase1(){
}

function setSampleState(state){
  const el = document.getElementById("sample-button");
  if (state){
    el.style.backgroundColor = "lightgreen";
    el.style.color = "black";
  }else{
    el.style.backgroundColor = "beige";
    el.style.color = "black";
  }
}

function setMeasureState(mode){
  document.getElementById("measure-button").style.backgroundColor =
  document.getElementById("pulse-button").style.backgroundColor = 
  document.getElementById("cycle-button").style.backgroundColor = 
  document.getElementById("block-button").style.backgroundColor = "beige";

  const el = document.getElementById(mode);
  if (state){
    el.style.backgroundColor = "lightgreen";
    el.style.color = "black";
  }else{
    el.style.backgroundColor = "beige";
    el.style.color = "black";
  }
}


function animateSample(){
  const samplestate = (Math.floor(tick/5) % 2 == 0) ?  true : false;
  setSampleState(samplestate);  

  const dt = data.length/2;
  const w = tick * dt;
  dc.fillStyle = "black";
  if (30+w < canvas.width-60) dc.fillRect(30+w,50, canvas.width-60-w, 200);
  else state = "calculate-statistics";
}

function animateStatistics(){
  dc.fillStyle = "black";
  dc.fillRect(30,350, canvas.width-60, statisics.tick);
  dc.fillRect(30,550, canvas.width-60, -statisics.tick);

  statisics.tick--;
  if (statisics.tick <= 0){
    state = "display-message";
  }
}

let statisics = {
  max: 0,
  min: 0,
  dt: 0,  
  graph: []
}

function calculateStatistics(){
  statisics.graph = [];
  statisics.max = 0;
  statisics.min = 0;
  for (var i = 0; i < data.length-1; i++){
    const dt = data[i+1].x - data[i].x;
    statisics.max = (statisics.max < dt) ? dt : statisics.max;
    statisics.min = (statisics.min > dt) ? dt : statisics.min;
  }

  document.getElementById("timing").innerHTML = "";
  const dt = (statisics.max - statisics.min)/190;
  const dx = (canvas.width-60) / 200;
  statisics.dt = dt/dx;
  for (var i = 1; i < 200; i++){
    statisics.graph.push({
      t1: statisics.min + dt*i,
      t2: statisics.min + dt*(i+1),
      x: 30 + i*dx,
      w: dx,
      low: 0,
      high:0
    });
    if (i%10 == 0){
      const el = document.createElement("div");
      el.style.width = "flex";
      el.style.height = "flex";
      el.style.left = (30+i*dx) + "px";
      el.style.top = (350+100) + "px";
      el.style.position = "absolute";
      el.style.zIndex = 2;
      el.style.fontSize = "11px";
      el.style.color = "beige";
      el.style.backgroundColor = "black";
      el.style.textAlign = "center"; // Ensure text alignment
      el.innerText = Math.floor(statisics.min + dt*i);
      document.getElementById("timing").appendChild(el);
    }
  }

  for (var i = 0; i < data.length-1; i++){
    const dt = data[i+1].x - data[i].x;
    const slot = statisics.graph.findIndex((s) => dt >= s.t1 && dt < s.t2);
    if (slot >= 0){
      if (data[i].y == 0) statisics.graph[slot].low++;
      else statisics.graph[slot].high++;
    }
  }

  let newGraph = [];
  for (var i = 0; i < statisics.graph.length; i++){
    if (statisics.graph[i].low > 0 || statisics.graph[i].high > 0){
      newGraph.push(statisics.graph[i]);
    }
  }
  statisics.graph = newGraph;
  statisics.tick = 99;

  document.getElementById("trigger-names").innerHTML = "";

  triggers.forEach((trigger) => {
    let x1 = Math.floor((trigger.t1) * (canvas.width-60)/statisics.max + 60);
    if (x1 > canvas.width-30) x1 = canvas.width-30;
    const y = (trigger.level == 0) ? 475 : 405;
    trigger.el = div("trigger", null, x1, y, 0, 0, trigger.key, "30px", "blue", true);
    document.getElementById("trigger-names").appendChild(trigger.el);
  });

  state = "animate-statistics";
}

function sampleBegin(newdata, title){
  tick = 0;
  data = newdata.slice();
  document.getElementById("timing").innerHTML = "";
  document.getElementById("message-title").style.display = 
  document.getElementById("message-string").style.display = "none";
  document.getElementById("message-title").innerText = 
  document.getElementById("message-string").innerText = "";
//  console.log(title);

  for (var i = 0; i < data.length-1; i++){
    const dt = data[i+1].x - data[i].x;
    const trigger = triggers.find((t) => dt >= t.t1 && dt < t.t2 && data[i].y == t.level);
    if (trigger != null){
      data[i].key = trigger.key;  
    }
    else{
      data[i].key = "NOISE";  
    }
  }
  data[data.length - 1].key = "STOP";

  let code = "";
  let xpos = -1;
  message = [];

  for (var i = 0; i < data.length; i++){
    switch(data[i].key){
      case "START":
        code = "";
        xpos = data[i+1].x;
        break;
      case "STOP":
        const k = codebook.find((c) => c.code == code);
        if (k != null){
//          console.log("found code: " + code + " -> " + k.key);
          message.push({ code: code, key: code, xpos: xpos });
//          message.push({ code: code, key: k.key, xpos: xpos });
        } else {
          codebook.push({ code: code, key: code});
          message.push({ code: code, key: code, xpos: xpos });
        }
        break;
      default:
        code += data[i].key;
        break;
    }
  }


  state = "sample";
}

let state = "initialize"
let tick = 0;
let decryptTick = 0;
function statemachine(){
  switch(state){
    case "initialize":
    // create buttons and lables
      div("label", null, 40, 10, 600, 25, "Analyzer v6", "40px" );  
      div("label", null, 40, 315, 600, 25, "Timing statistics & pulse decoding", "30px" );  
      div("label", null, 40, 615, 600, 25, "Codebook", "30px" );  
      el = div("label", "message-title", 40, 660, 600, 25, "", "16px", "lightgreen" );  
      el.style.display = "none";
      el = div("label", "message-string", 40, 690, 600, 50, "", "50px", "lightgreen" );  
      el.style.display = "none";
      div("cursor", "cursor", 0, 60, 30, 250, "1000", "21px", "lightgreen", true);
      div("cursor", "statistics-cursor", 0, 360, 30, 250, "1000", "21px", "lightgreen", true);
      div("label", null, 40, 265, 30, 30, "Macro", "14px", "black", true);
      div("macro-button", "macro-record", 100, 260, 30, 30, "⏺️", "25px", "white", true);
      div("macro-button", "macro-stop", 130, 260, 30, 30, "⏹️", "25px", "white", true);
      div("macro-button", "macro-play-pause", 160, 260, 30, 30, "▶️", "25px", "white", true);
      div("label", "macro-time", 200, 265, 30, 30, "00:00:00:000", "14px", "black", true);
      let xpos = 300;
      let width = 110;
      div("measure-button", "sample-button", xpos, 15, width, 30, "Capture", "21px", "black", true);
      xpos += width + 30;
      div("measure-button", "measure-button", xpos, 15, width, 30, "Measure", "21px", "black", true);
      xpos += width + 30;
      div("measure-button", "state-button", xpos, 22, width*2, 20, "Pan", "11px", "black", true);
/*      xpos += width + 100;
      div("measure-button", "a-button", xpos, 22, 20, 20, "A", "18px", "black", true);
      xpos += 25;
      div("measure-button", "b-button", xpos, 22, 20, 20, "B", "18px", "black", true);
      xpos += 25;
      div("measure-button", "c-button", xpos, 22, 20, 20, "C", "18px", "black", true);
      xpos += 25;
      div("measure-button", "d-button", xpos, 22, 20, 20, "D", "18px", "black", true);
      xpos += 25;
      div("measure-button", "e-button", xpos, 22, 20, 20, "E", "18px", "black", true);
      xpos += 25;
      div("measure-button", "f-button", xpos, 22, 20, 20, "F", "18px", "black", true);
      xpos += 25;
      div("measure-button", "g-button", xpos, 22, 20, 20, "G", "18px", "black", true);
      xpos += 25;
      div("measure-button", "h-button", xpos, 22, 20, 20, "H", "18px", "black", true);
*/      data = [];
      state = "idle";
      break;
    case "sample-begin":
      sampleBegin();
      break;
    case "calculate-statistics":
      calculateStatistics();
      break;
    case "display-message":
      message.forEach((m) => {
        const xpos = Math.floor((m.xpos) * (canvas.width-60)/data[data.length-1].x + 35);
        m.el = div("message-label", null, xpos, 215, 0, 0, m.key, "21px", "white" );
      });
      state = "init-decrypt";
      break;
    case "init-decrypt":
      document.getElementById("message-title").style.display = "block";
      document.getElementById("message-title").innerText = "Decoding message:";
      document.getElementById("message-string").style.display = "block";
      document.getElementById("message-string").style.width = canvas.width-60 + "px";
      document.getElementById("message-string").style.overflow = "hidden";
      document.getElementById("message-string").style.whiteSpace = "nowrap";
      decryptTick = tick + 200;
      state = "decrypt";
      break;

    case "decrypt":
      if ((decryptTick - tick)%10 == 0){      
        const chars = "!#€%&/()=?1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let newString = "";
        const tal = (decryptTick - tick)/200;
        message.forEach((m) => {
          let l = Math.floor(m.code.length * tal);
          if (l < 1) l = 1;
          m.decrypt = m.code.substring(0, l);
          let reszult = "";
          for (var i = 0; i < l; i++){
            reszult += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          m.el.innerText = reszult;
          m.decrypt = reszult;
          newString = newString + reszult + ";";
        });
//        console.log(newString);
        document.getElementById("message-string").innerText = newString;
      }
      if (tick > decryptTick){
        let newString = "";
        message.forEach((m) => {
          const k = codebook.find((c) => c.code == m.code);
          if (k != null){
            m.el.innerText = m.decrypt = k.key;
            newString = newString + k.key + ";";
          }
        });
        newString = "";
        message.forEach((m) => {
          if (m.decrypt != "EOL") newString = newString + m.decrypt;
        });
        document.getElementById("message-string").innerText = newString;
        state = "post-decrypt";
        decryptTick = tick + 200;
      } 
      break;
    case "post-decrypt":
      if (tick > decryptTick){
        let newString = "";
        message.forEach((m) => {
          if (m.decrypt != "EOL") newString = newString + m.decrypt;
        });
        document.getElementById("message-string").innerText = newString;
        state = "idle";
        //document.getElementById("message-title").style.display = "none";
        //document.getElementById("message-string").style.display = "none";
      } 
      break;
    case "init-glitch":
      decryptTick = tick + 500;
      state = "glitch";
      break;
    case "glitch":
      if (tick % 100 < 50){
        carbonCopy(true);
      } else {
        glitch();
      }
      if (tick > decryptTick){
        state = "end-glitch";
      }
      break;
    case "end-glitch":
      carbonCopy(false);
      animateflag = true;
      requestAnimationFrame(animate);
      state = "idle";
      break;
  }
  if (data.length == 0){
    document.getElementById("statistics-cursor").style.display =
    document.getElementById("cursor").style.display = "none";
  }
  else{
    document.getElementById("statistics-cursor").style.display =
    document.getElementById("cursor").style.display = "block";
  }



  tick++;
  if (macro.state == "record"){
    document.getElementById("macro-record").style.display = (Math.floor(tick/20) % 2 == 0) ? "block" : "none";
    updateMacroTimer(Date.now() - macro.starttime);
  } else if (macro.state == "play"){
    document.getElementById("macro-play-pause").style.display = (Math.floor(tick/20) % 2 == 0) ? "block" : "none";
    customCursor.style.display = "block";
    const time = Date.now() - macro.playtime;
    updateMacroTimer(time);
    while (macro.datapointer < macro.data.length && macro.data[macro.datapointer].time < time){ 
      switch(macro.data[macro.datapointer].action){
        case "mousemove":
          moveMacroCursor(macro.data[macro.datapointer].x, macro.data[macro.datapointer].y);
          break;
        case "sample-button":
//          state = "sample-begin";
          handleSampleButton();
          break;
      }
      macro.datapointer++;
    }
    if (macro.datapointer >= macro.data.length){
      macro.state = "idle";
      document.getElementById("macro-play-pause").style.display = "block";
      customCursor.style.display = "none";
      updateMacroTimer(macro.data[macro.data.length-1].time);
    }
  }

  document.getElementById("state-button").innerText = state + ": " + tick;
}

function handleSampleButton(){
  if (state == "idle"){
    if (captureindex >= capturequeue.length){
      animateflag = false;
      state = "init-glitch";
    } else {
      animateflag = true;
      requestAnimationFrame(animate);
      sampleBegin(capturequeue[captureindex], "rawdata");
      captureindex++;
    }
  }
}


function updateCodebook(){
  const el = document.getElementById("codebook-input");
  const values = el.value.split(";");

  for (var i = 0; i < values.length; i++){
    message[i].el.innerText = values[i];
  }

  for (var i = 0; i < message.length; i++){
    const k = codebook.find((c) => c.code == message[i].code);
    if (k != null){
      k.key = message[i].el.innerText;
    }
  }

  console.log(JSON.stringify(codebook));

}

function updateMacroTimer(time){
  const elapsed = new Date(time);
  const hours = String(elapsed.getUTCHours()).padStart(2, '0');
  const minutes = String(elapsed.getUTCMinutes()).padStart(2, '0');
  const seconds = String(elapsed.getUTCSeconds()).padStart(2, '0');
  const milliseconds = String(elapsed.getUTCMilliseconds()).padStart(3, '0');
  const timeString = hours + ":" + minutes + ":" + seconds + "." + milliseconds;
  document.getElementById("macro-time").innerText = timeString; 
}

function handleRecord(action){
  if (macro.state == "record"){
    const time = Date.now() - macro.starttime;
    macro.data.push({time: time, x: mouse.x, y: mouse.y, action: action});
  }
}

// Function to move the custom cursor
function moveMacroCursor(x, y) {
  customCursor.style.left = x + "px";
  customCursor.style.top = y + "px";
  mouse.x = x;
  mouse.y = y;
}

let macro = {
  state: "idle",
  starttime: 0,
  playtime: 0,
  datapointer: 0,
  data: []
};


let mouse = {
  x: 0,
  y: 0,
  down: false
};

function carbonCopy(draw){
  // render GUI
  dc.clearRect(0, 0, canvas.width, canvas.height);
  dc.fillStyle = "black";
  dc.fillRect(30, 50, canvas.width-60, 200);
  dc.fillRect(0, 280, canvas.width, 20);
  dc.fillRect(30, 350, canvas.width-60, 200);
  dc.fillRect(0, 580, canvas.width, 20);
  dc.fillRect(30, 650, canvas.width-60, 200);

  // render data
  if (data.length > 0){
    dc.fillStyle = "white";
    let dataxmin = 0
    let dataxmax = data[data.length-1].x;
    let viewxmin = 30;
    let viewxmax = this.canvas.width-30;
    const dx = (viewxmax - viewxmin) / (dataxmax - dataxmin);
    const yposlow = 200;
    const yposhigh = 100;
    const ymiddle = (yposlow + yposhigh) / 2;

    dc.strokeStyle = "lightgreen";
    dc.lineWidth = 2;
    dc.beginPath();
    var first = true;
    var previousy = 0;
    for (var i = 0; i < data.length; i++){
      const x = Math.floor((data[i].x - dataxmin) * dx + viewxmin);
      if (first){
        previousy = data[i].y; 
        first = false;
        dc.moveTo(x, (previousy == 0) ? yposlow : yposhigh);
      }else{
        dc.lineTo(x, (previousy == 0) ? yposlow : yposhigh);
        previousy = data[i].y; 
        dc.lineTo(x, (previousy == 0) ? yposlow : yposhigh);
      }
    }
    dc.stroke();
  }

  // render statistics
  if (statisics.graph.length > 0){
  // render pulse sections
  const dx = (canvas.width-60)/statisics.max;
  trigger1Hover = trigger2Hover = trigger3Hover = null; 
  triggers.forEach((trigger) => {
    const x1 = Math.floor((trigger.t1) * dx + 30);
    let w = Math.floor((trigger.t2 - trigger.t1) * dx);
    if (x1+w > canvas.width-30) w = canvas.width-30-x1;
    const dy = (trigger.level == 0) ? 50 : -50;
    const y = (trigger.level == 0) ? 455 : 445;
    const my = Math.abs(mouse.y - y - dy/2);
    const y1 = Math.min(y, y+dy);
    const y2 = Math.max(y, y+dy);
    if (x1 < mouse.x && mouse.x < x1+w && y1 < mouse.y && mouse.y < y2){
      trigger3Hover = trigger;
      dc.fillStyle = "yellow";
    } else{
      dc.fillStyle = "pink";
    }
    dc.fillRect(x1, y, w, dy);
    dc.lineWidth = 4;
    dc.strokeStyle = ((Math.abs(mouse.x - x1) < 10)&&(my < 25)) ? "white": "red";
    if ((Math.abs(mouse.x - x1) < 10)&&(my < 25)) trigger1Hover = trigger;
    dc.beginPath();
    dc.moveTo(x1, y);
    dc.lineTo(x1, y+dy);
    dc.stroke();
    dc.strokeStyle = ((Math.abs(mouse.x - x1 - w) < 10)&&(my < 25)) ? "white": "red";
    if ((Math.abs(mouse.x - x1 - w) < 10)&&(my < 25)) trigger2Hover = trigger;
    dc.beginPath();
    dc.moveTo(x1+w, y);
    dc.lineTo(x1+w, y+dy);
    dc.stroke();
    trigger.x1 = x1;
    trigger.x2 = x1+w;
  });


  if (data.length>0 && trigger3Hover != null){
    let dataxmin = 0
    let dataxmax = data[data.length-1].x;
    let viewxmin = 30;
    let viewxmax = this.canvas.width-30;
    const dx = (viewxmax - viewxmin) / (dataxmax - dataxmin);
    const yposlow = 200;
    const yposhigh = 100;

    dc.strokeStyle = "yellow";
    dc.lineWidth = 6;
    dc.beginPath();
    for (var i = 0; i < data.length-1; i++){
      const dt = data[i+1].x - data[i].x;
      if (dt < trigger3Hover.t1 || dt > trigger3Hover.t2 || data[i].y != trigger3Hover.level) continue;
      const x1 = Math.floor((data[i].x - dataxmin) * dx + viewxmin);
      const x2 = Math.floor((data[i+1].x - dataxmin) * dx + viewxmin);
      dc.moveTo(x1, (data[i].y == 0) ? yposlow : yposhigh);
      dc.lineTo(x2, (data[i].y == 0) ? yposlow : yposhigh);
    }
    dc.stroke();
  }

  // render statistics
    dc.fillStyle = "lightgreen";
    for(var i = 0; i < statisics.graph.length; i++){
      const x = statisics.graph[i].x;
      let y1 = - statisics.graph[i].high*20;
      if (y1 < -90) y1 = -90;
      dc.fillRect(x, 450, statisics.graph[i].w, y1);
      let y2 = statisics.graph[i].low*20; 
      if (y2 > 90) y2 = 90;
      dc.fillRect(x, 450, statisics.graph[i].w, y2);
    }
    dc.beginPath();
    dc.moveTo(30, 450);
    dc.lineTo(canvas.width-30, 450);
    dc.strokeStyle = "lightgreen";
    dc.lineWidth = 2;
    dc.stroke();
  }

  // render cursor
  if (data.length > 0){
    let dataxmin = 0
    let dataxmax = data[data.length-1].x;
    let viewxmin = 30;
    let viewxmax = this.canvas.width-30;
    const dx = (viewxmax - viewxmin) / (dataxmax - dataxmin);
    const yposlow = 200;
    const yposhigh = 100;
    const ymiddle = (yposlow + yposhigh) / 2;

    var cursorx = mouse.x;
    if (cursorx < 30) cursorx = 30;
    else if (cursorx > this.canvas.width-30) cursorx = this.canvas.width-30;

    const el = document.getElementById("cursor");
    el.innerText = Math.floor(dataxmax * (cursorx-30)/viewxmax)  + " us";
    const xoffset = (mouse.x+el.offsetWidth < canvas.width-60) ? el.offsetWidth-20 : -el.offsetWidth;
    el.style.left = (cursorx + xoffset) + "px";

    const statel = document.getElementById("statistics-cursor");
    statel.innerText = Math.floor(statisics.dt*(cursorx-viewxmin))  + " us";
    const statxoffset = (mouse.x+statel.offsetWidth < canvas.width-60) ? statel.offsetWidth-15 : -statel.offsetWidth;
    statel.style.left = (cursorx + statxoffset) + "px";

    dc.strokeStyle = "lightgreen";
    dc.lineWidth = 2;
    dc.beginPath();
    dc.moveTo(cursorx, 50);
    dc.lineTo(cursorx, 250);
    dc.moveTo(cursorx, 350);
    dc.lineTo(cursorx, 550);
    dc.stroke();
  }

  if (draw){
    const settings = document.getElementById("settings");
    for (var i = 0; i < settings.children.length; i++){
      const child = settings.children[i];
      dc.fillStyle = child.style.color;
      dc.font = child.style.fontSize + " sans-serif";
      dc.fillText(child.innerText, parseInt(child.style.left), parseInt(child.style.top) + parseInt(child.style.fontSize) - 10); 
    }
    settings.style.display = "none";

    const timing = document.getElementById("timing");
    for (var i = 0; i < timing.children.length; i++){
      const child = timing.children[i];
      dc.fillStyle = child.style.color;
      dc.font = child.style.fontSize + " sans-serif";
      dc.fillText(child.innerText, parseInt(child.style.left), parseInt(child.style.top) + parseInt(child.style.fontSize) - 10); 
    }
    timing.style.display = "none";

    const triggernames = document.getElementById("trigger-names");  
    for (var i = 0; i < triggernames.children.length; i++){
      const child = triggernames.children[i];
      dc.fillStyle = child.style.color;
      dc.font = child.style.fontSize + " sans-serif";
      dc.fillText(child.innerText, parseInt(child.style.left), parseInt(child.style.top) + parseInt(child.style.fontSize) - 10); 
    }
    triggernames.style.display = "none";
  } else{
    settings.style.display = 
    timing.style.display = 
    triggernames.style.display = "block";
  }
}

function animate() {

// rebder GUI
  dc.clearRect(0, 0, canvas.width, canvas.height);
  dc.fillStyle = "black";
  dc.fillRect(30, 50, canvas.width-60, 200);
  dc.fillRect(0, 280, canvas.width, 20);
  dc.fillRect(30, 350, canvas.width-60, 200);
  dc.fillRect(0, 580, canvas.width, 20);
  dc.fillRect(30, 650, canvas.width-60, 200);

// render data
  if (data.length > 0){
    dc.fillStyle = "white";
    let dataxmin = 0
    let dataxmax = data[data.length-1].x;
    let viewxmin = 30;
    let viewxmax = this.canvas.width-30;
    const dx = (viewxmax - viewxmin) / (dataxmax - dataxmin);
    const yposlow = 200;
    const yposhigh = 100;
    const ymiddle = (yposlow + yposhigh) / 2;

    dc.strokeStyle = "lightgreen";
    dc.lineWidth = 2;
    dc.beginPath();
    var first = true;
    var previousy = 0;
    for (var i = 0; i < data.length; i++){
      const x = Math.floor((data[i].x - dataxmin) * dx + viewxmin);
      if (first){
        previousy = data[i].y; 
        first = false;
        dc.moveTo(x, (previousy == 0) ? yposlow : yposhigh);
      }else{
        dc.lineTo(x, (previousy == 0) ? yposlow : yposhigh);
        previousy = data[i].y; 
        dc.lineTo(x, (previousy == 0) ? yposlow : yposhigh);
      }
    }
    dc.stroke();
}

// render statistics
if (statisics.graph.length > 0){
  // render pulse sections
  const dx = (canvas.width-60)/statisics.max;
  trigger1Hover = trigger2Hover = trigger3Hover = null; 
  triggers.forEach((trigger) => {
    const x1 = Math.floor((trigger.t1) * dx + 30);
    let w = Math.floor((trigger.t2 - trigger.t1) * dx);
    if (x1+w > canvas.width-30) w = canvas.width-30-x1;
    const dy = (trigger.level == 0) ? 50 : -50;
    const y = (trigger.level == 0) ? 455 : 445;
    const my = Math.abs(mouse.y - y - dy/2);
    const y1 = Math.min(y, y+dy);
    const y2 = Math.max(y, y+dy);
    if (x1 < mouse.x && mouse.x < x1+w && y1 < mouse.y && mouse.y < y2){
      trigger3Hover = trigger;
      dc.fillStyle = "yellow";
    } else{
      dc.fillStyle = "pink";
    }
    dc.fillRect(x1, y, w, dy);
    dc.lineWidth = 4;
    dc.strokeStyle = ((Math.abs(mouse.x - x1) < 10)&&(my < 25)) ? "white": "red";
    if ((Math.abs(mouse.x - x1) < 10)&&(my < 25)) trigger1Hover = trigger;
    dc.beginPath();
    dc.moveTo(x1, y);
    dc.lineTo(x1, y+dy);
    dc.stroke();
    dc.strokeStyle = ((Math.abs(mouse.x - x1 - w) < 10)&&(my < 25)) ? "white": "red";
    if ((Math.abs(mouse.x - x1 - w) < 10)&&(my < 25)) trigger2Hover = trigger;
    dc.beginPath();
    dc.moveTo(x1+w, y);
    dc.lineTo(x1+w, y+dy);
    dc.stroke();
    trigger.x1 = x1;
    trigger.x2 = x1+w;
  });


  if (data.length>0 && trigger3Hover != null){
    let dataxmin = 0
    let dataxmax = data[data.length-1].x;
    let viewxmin = 30;
    let viewxmax = this.canvas.width-30;
    const dx = (viewxmax - viewxmin) / (dataxmax - dataxmin);
    const yposlow = 200;
    const yposhigh = 100;

    dc.strokeStyle = "yellow";
    dc.lineWidth = 6;
    dc.beginPath();
    for (var i = 0; i < data.length-1; i++){
      const dt = data[i+1].x - data[i].x;
      if (dt < trigger3Hover.t1 || dt > trigger3Hover.t2 || data[i].y != trigger3Hover.level) continue;
      const x1 = Math.floor((data[i].x - dataxmin) * dx + viewxmin);
      const x2 = Math.floor((data[i+1].x - dataxmin) * dx + viewxmin);
      dc.moveTo(x1, (data[i].y == 0) ? yposlow : yposhigh);
      dc.lineTo(x2, (data[i].y == 0) ? yposlow : yposhigh);
    }
    dc.stroke();
  }

// render statistics
    dc.fillStyle = "lightgreen";
    for(var i = 0; i < statisics.graph.length; i++){
      const x = statisics.graph[i].x;
      let y1 = - statisics.graph[i].high*20;
      if (y1 < -90) y1 = -90;
      dc.fillRect(x, 450, statisics.graph[i].w, y1);
      let y2 = statisics.graph[i].low*20; 
      if (y2 > 90) y2 = 90;
      dc.fillRect(x, 450, statisics.graph[i].w, y2);
    }
    dc.beginPath();
    dc.moveTo(30, 450);
    dc.lineTo(canvas.width-30, 450);
    dc.strokeStyle = "lightgreen";
    dc.lineWidth = 2;
    dc.stroke();
  }

  // render cursor
  if (data.length > 0){
    let dataxmin = 0
    let dataxmax = data[data.length-1].x;
    let viewxmin = 30;
    let viewxmax = this.canvas.width-30;
    const dx = (viewxmax - viewxmin) / (dataxmax - dataxmin);
    const yposlow = 200;
    const yposhigh = 100;
    const ymiddle = (yposlow + yposhigh) / 2;

    var cursorx = mouse.x;
    if (cursorx < 30) cursorx = 30;
    else if (cursorx > this.canvas.width-30) cursorx = this.canvas.width-30;

    const el = document.getElementById("cursor");
    el.innerText = Math.floor(dataxmax * (cursorx-30)/viewxmax)  + " us";
    const xoffset = (mouse.x+el.offsetWidth < canvas.width-60) ? el.offsetWidth-20 : -el.offsetWidth;
    el.style.left = (cursorx + xoffset) + "px";

    const statel = document.getElementById("statistics-cursor");
    statel.innerText = Math.floor(statisics.dt*(cursorx-viewxmin))  + " us";
    const statxoffset = (mouse.x+statel.offsetWidth < canvas.width-60) ? statel.offsetWidth-15 : -statel.offsetWidth;
    statel.style.left = (cursorx + statxoffset) + "px";

    dc.strokeStyle = "lightgreen";
    dc.lineWidth = 2;
    dc.beginPath();
    dc.moveTo(cursorx, 50);
    dc.lineTo(cursorx, 250);
    dc.moveTo(cursorx, 350);
    dc.lineTo(cursorx, 550);
    dc.stroke();
  }


  switch(state){
    case "idle":
      break;
    case "sample":
      animateSample();
      break;
    case "calculate-statistics":
      break;
    case "animate-statistics":
      animateStatistics();
      break;
    case "decrypt":
      dc.fillStyle = "black";
      dc.fillRect(300, 610, 500, 30);
      dc.strokeStyle = "lightgreen";
      dc.lineWidth = 2;
      dc.beginPath();
      dc.rect(300, 610, 500, 30);
      dc.stroke();
      const percent = Math.floor(500-(decryptTick - tick)/200 * 500);
      dc.fillStyle = "lightgreen";
      dc.fillRect(300, 610, percent, 30);
      dc.fillStyle = "green";
      dc.font = "20px Arial";
      dc.fillText("Decrypting message... " + Math.floor(percent/5) + "%", 310, 630);
      break;
    case "post-decrypt":
      dc.fillStyle = "black";
      dc.fillRect(300, 610, 500, 30);
      dc.strokeStyle = "lightgreen";
      dc.lineWidth = 2;
      dc.beginPath();
      dc.rect(300, 610, 500, 30);
      dc.stroke();
      dc.fillStyle = "lightgreen";
      dc.fillRect(300, 610, 500, 30);
      dc.fillStyle = "green";
      dc.font = "20px Arial";
      dc.fillText("Message decoded", 310, 630);
      break;
  }
  if (animateflag) requestAnimationFrame(animate);
}

/******************************************************
// program starts here
 ******************************************************/
const canvas = document.createElement("canvas");
canvas.id = "canvas";
canvas.width = window.innerWidth-10;
canvas.height = window.innerHeight-10;
canvas.style.position = "absolute";
canvas.style.zIndex = 1;
canvas.style.backgroundColor = "beige";
document.body.appendChild(canvas);
const dc = canvas.getContext('2d', {
  willReadFrequently: true
});

// Create a custom cursor element
const customCursor = div("custom-cursor", "custom-cursor", 0, 0, 10, 10, "", "", "", true);
animate();

window.addEventListener('resize', function(){
  canvas.width = window.innerWidth-10;
  canvas.height = window.innerHeight-10;
});

canvas.addEventListener('mousemove', function(evt){
  var rect = canvas.getBoundingClientRect();
  mouse.x = evt.clientX - rect.left;
  mouse.y = evt.clientY - rect.top;
  handleRecord("mousemove");

  if ((mouse.down)&&(trigger1Hover != null)){
    trigger1Hover.t1 = Math.floor((mouse.x-30) * statisics.max / (canvas.width-60));
    if (trigger1Hover.t1 < 0) trigger1Hover.t1 = 0;
    if (trigger1Hover.t1 > trigger1Hover.t2-20) trigger1Hover.t1 = trigger1Hover.t2-20;
    trigger1Hover.el.style.left = (30 + mouse.x) + "px";
  }
  else if ((mouse.down)&&(trigger2Hover != null)){
    trigger2Hover.t2 = Math.floor((mouse.x-30) * statisics.max / (canvas.width-60));
    if (trigger2Hover.t2 > statisics.max) trigger2Hover.t2 = statisics.max;
    if (trigger2Hover.t2 < trigger2Hover.t1+20) trigger2Hover.t2 = trigger2Hover.t1+20;
  }
});

canvas.addEventListener('mousedown', function(evt){
  mouse.down = true;
});

canvas.addEventListener('mouseup', function(evt){
  mouse.down = false;
});

setInterval(statemachine, 1000/60);
//setInterval(glitch, 200); // Apply glitch every 200ms

function glitch() {

  const sliceCount = 10;
  for (let i = 0; i < sliceCount; i++) {
    const x = 0;
    const y = Math.random() * canvas.height;
    const width = canvas.width;
    const height = Math.random() * 10 + 5;

    const dx = Math.random() * 20 - 10; // horizontal shift
    const imageData = dc.getImageData(x, y, width, height);
    dc.putImageData(imageData, dx, y);
  }

  // Optional: Add RGB channel separation
  const imgData = dc.getImageData(0, 0, canvas.width, canvas.height);
  for (let i = 0; i < imgData.data.length; i += 4) {
    imgData.data[i] = imgData.data[i + 1];     // Red
    imgData.data[i + 2] = imgData.data[i];     // Blue
  }
  dc.putImageData(imgData, 0, 0);

}

function loadData() {
  const xhr = new XMLHttpRequest();
  
  // The URL for the AJAX request (replace with your endpoint)
  const url = '/getdata';
  
  // Open a GET request to the specified URL
  xhr.open('POST', url, true);
  
  // Event handler for when the request has completed
  xhr.onload = function () {
      if (xhr.status === 200) {  // Status 200 means "OK"
          data = JSON.parse(xhr.responseText);

      } else {
          data = [{"x":0,"y":0},{"x":1576,"y":1},{"x":2133,"y":0},{"x":2399,"y":1},{"x":3414,"y":0},{"x":4139,"y":1},{"x":5121,"y":0},{"x":5845,"y":1},{"x":6828,"y":0},{"x":7095,"y":1},{"x":7682,"y":0},{"x":7955,"y":1},{"x":8535,"y":0},{"x":8806,"y":1},{"x":9392,"y":0},{"x":9662,"y":1},{"x":10243,"y":0},{"x":10964,"y":1},{"x":13043,"y":0},{"x":14621,"y":1},{"x":15601,"y":0},{"x":16358,"y":1},{"x":16881,"y":0},{"x":17179,"y":1},{"x":18163,"y":0},{"x":18889,"y":1},{"x":19870,"y":0},{"x":20168,"y":1},{"x":20723,"y":0},{"x":21021,"y":1},{"x":21577,"y":0},{"x":21848,"y":1},{"x":22431,"y":0},{"x":23161,"y":1},{"x":24138,"y":0},{"x":24411,"y":1},{"x":26083,"y":0},{"x":27668,"y":1},{"x":28644,"y":0},{"x":28948,"y":1},{"x":29498,"y":0},{"x":29770,"y":1},{"x":30351,"y":0},{"x":30626,"y":1},{"x":31205,"y":0},{"x":31936,"y":1},{"x":32912,"y":0},{"x":33184,"y":1},{"x":33766,"y":0},{"x":34070,"y":1},{"x":34620,"y":0},{"x":34928,"y":1},{"x":35473,"y":0},{"x":36205,"y":1},{"x":36753,"y":0},{"x":37027,"y":1},{"x":39132,"y":0},{"x":40745,"y":1},{"x":41694,"y":0},{"x":41995,"y":1},{"x":42547,"y":0},{"x":42852,"y":1},{"x":43401,"y":0},{"x":43707,"y":1},{"x":44254,"y":0},{"x":45013,"y":1},{"x":45963,"y":0},{"x":46240,"y":1},{"x":46816,"y":0},{"x":47116,"y":1},{"x":47669,"y":0},{"x":48400,"y":1},{"x":49377,"y":0},{"x":49680,"y":1},{"x":50234,"y":0},{"x":50535,"y":1},{"x":52176,"y":0},{"x":53766,"y":1},{"x":54738,"y":0},{"x":55440,"y":1},{"x":56019,"y":0},{"x":56323,"y":1},{"x":57299,"y":0},{"x":58001,"y":1},{"x":59007,"y":0},{"x":59285,"y":1},{"x":59861,"y":0},{"x":60163,"y":1},{"x":60715,"y":0},{"x":61440,"y":1},{"x":62422,"y":0},{"x":63152,"y":1},{"x":65242,"y":0},{"x":66399,"y":1},{"x":66950,"y":0},{"x":67651,"y":1},{"x":68229,"y":0},{"x":68505,"y":1},{"x":69513,"y":0},{"x":69811,"y":1},{"x":70365,"y":0},{"x":70667,"y":1},{"x":71218,"y":0},{"x":71519,"y":1},{"x":72072,"y":0},{"x":72345,"y":1},{"x":72926,"y":0},{"x":73223,"y":1},{"x":73780,"y":0},{"x":74509,"y":1},{"x":75488,"y":0},{"x":75762,"y":1},{"x":76341,"y":0},{"x":76639,"y":1}];
      }
  };

  // Send the request
  xhr.send();
}





